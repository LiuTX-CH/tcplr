---
title: "class9"
output: learnr::tutorial
runtime: shiny_prerendered
---

```{r setup, include=FALSE}
library(learnr)
knitr::opts_chunk$set(echo = FALSE)
```


## 
<h1> 政治学数据分析与编程 </h1>
<h2> 第九讲 </h2>

吕杰

中国人民大学国际关系学院政治学系

<script language=JavaScript>
today=new Date();
function initArray(){
this.length=initArray.arguments.length
for(var i=0;i<this.length;i++)
this[i+1]=initArray.arguments[i] }
var d=new initArray(
"星期日",
"星期一",
"星期二",
"星期三",
"星期四",
"星期五",
"星期六");
document.write(
"<font color=#333 style='font-size:9pt;font-family: 楷体'> ",
today.getFullYear(),"年",
today.getMonth()+1,"月",
today.getDate(),"日",
d[today.getDay()+1],
"</font>" );
</script>

## 内容提纲

+ 双变量到多变量分析
+ 结果变量是连续变量
+ OLS 模型统计鉴定
+ 结果变量是二分变量

## 为什么要多变量？
更加有效地检验理论

+ 可能的竞争性解释
  * 来源？
  * 控制方式？
+ 所谓的遗漏变量问题
  * 多少个遗漏变量？
  * 所有的遗漏变量都会导致偏误吗？
  
## 解释变量 vs. 控制变量
如何区分解释变量和控制变量？

+ 都属于右手侧变量
+ 都跟理论密切相关
+ 都有相应的文献支持
+ 研究目的决定区分

## 多变量统计模型的分类
如何划分不同类型的多变量统计模型？

+ 结果变量的测量类型
  * 连续（OLS）
  * 二分（Logit/Probit）
  * 定序多分（Ordered Logit/Ordered Probit）
  * 类别多分（Multinominal Logistic）
+ 数据结构的特征
  * 单层/多层截面
  * 单层时序
  * 多层混合时序截面
+ 结果变量的数目
  * 单一结果变量
  * 多个结果变量（Simultaneous equations/Structural equations）
  
## 基本模型设定
$y_i = \beta_0 + \beta_1x_{1i} + \beta_2x_{2i} + \epsilon_{0i}$

+ 截距（intercept）：$\beta_0$
+ 回归系数（regression coefficient）：$\beta_1$和$\beta_2$
+ 前提假设
  * $E(\epsilon_0) = 0$
  * $Cov(x_j,\epsilon_0) = 0$
  * $Var(\epsilon_0) = \sigma^2$
  * IID (Independent Identitical Distribution)
  * 多元正态分布（Multivariate Normal Distribution）
  * 线性叠加关系（Linear in parameters）
  
## 控制变量的影响 I
```{r inte, exercise=TRUE}
suppressMessages(library(tidyverse))
ggplot(data = mtcars, aes(x = wt, y = mpg)) +
  geom_point() +
  scale_x_continuous(limits = c(0, 6), breaks = seq(1, 6, by = 1)) +
  scale_y_continuous(limits = c(0, 40), breaks = seq(10, 40, by = 5)) +
  xlab("Weight (tons)") +
  ylab("Fuel Efficiency (mpg)") +
  ggtitle("Fuel Efficiency by Weight \n (Automobiles)")
```

## 控制变量的影响 II
$MPG = \beta_0 + \beta_1 * Weight + \epsilon_0$
```{r inte2, exercise=TRUE}
suppressMessages(library(tidyverse))
ols1 <- lm(mpg ~ wt, data = mtcars)
ggplot(data = mtcars, aes(x = wt, y = mpg)) +
  geom_point() +
  scale_x_continuous(limits = c(0, 6), breaks = seq(1, 6, by = 1)) +
  scale_y_continuous(limits = c(0, 40), breaks = seq(10, 40, by = 5)) +
  xlab("Weight (tons)") +
  ylab("Fuel Efficiency (mpg)") +
  ggtitle("Fuel Efficiency by Weight \n (Automobiles)") +
  geom_segment(aes(x = min(wt), y = ols1[[1]][1] + ols1[[1]][2]*min(wt),
                   xend = max(wt), yend = ols1[[1]][1] + ols1[[1]][2]*max(wt),
                   color = "red"))
```


## 控制变量的影响 III
$MPG = \beta_0 + \beta_1*Weight + \beta_2*Clinder + \epsilon_0$
```{r inte3, exercise=TRUE}
suppressMessages(library(tidyverse))
ols1 <- lm(mpg ~ wt, data = mtcars)
ols2 <- lm(mpg ~ wt + cyl, data = mtcars)
ggplot(data = mtcars, aes(x = wt, y = mpg)) +
  geom_point() +
  scale_x_continuous(limits = c(0, 6), breaks = seq(1, 6, by = 1)) +
  scale_y_continuous(limits = c(0, 40), breaks = seq(10, 40, by = 5)) +
  xlab("Weight (tons)") +
  ylab("Fuel Efficiency (mpg)") +
  ggtitle("Fuel Efficiency by Weight \n (Automobiles)") +
  geom_segment(aes(x = min(wt), y = ols1[[1]][1] + ols1[[1]][2]*min(wt),
                   xend = max(wt), yend = ols1[[1]][1] + ols1[[1]][2]*max(wt)),
                   color = "red") +
  geom_segment(aes(x = min(wt), y = ols2[[1]][1] + ols2[[1]][2]*min(wt),
                   xend = max(wt), yend = ols2[[1]][1] + ols2[[1]][2]*max(wt)),
                   color = "purple") +
  ggtitle("Fuel Efficiency by Weight \n (Automobiles with Different Cylinders)")
```

## 控制变量的影响 IV
$MPG = \beta_0 + \beta_1 * Weight + \epsilon_0$
```{r inte4, exercise=TRUE}
suppressMessages(library(stargazer))
stargazer(lm(mpg ~ wt, data = mtcars), type = "text",
          title = "Fuel Efficiency by Weight")
```


## 控制变量的影响 V
$MPG = \beta_0 + \beta_1*Weight + \beta_2*Clinder + \epsilon_0$
```{r inte5, exercise=TRUE}
suppressMessages(library(stargazer))
stargazer(lm(mpg ~ wt + cyl, data = mtcars), type = "text",
          title = "Fuel Efficiency by Weight and Cylinder")
```

## 控制变量的影响 VI
```{r inte6, exercise=TRUE}
suppressMessages(library(tidyverse))
mtcars$am <- factor(mtcars$am, labels = c("Auto", "Manual"))
ggplot(data = mtcars, aes(x = wt, y = mpg, shape = am)) +
  geom_point() +
  geom_smooth(method = "lm") +
  scale_x_continuous(limits = c(0, 6), breaks = seq(1, 6, by = 1)) +
  scale_y_continuous(limits = c(0, 40), breaks = seq(10, 40, by = 5)) +
  xlab("Weight (tons)") +
  ylab("Fuel Efficiency (mpg)") +
  labs(shape = "Transmission") +
  ggtitle("Fuel Efficiency by Weight \n (Automobiles)")
```

## 控制变量的影响 VII
以下两种方式纳入不同传动机制的控制有什么不同？

$MPG = \beta_0 + \beta_1 * Weight + \beta_2*AM + \epsilon_0$
$MPG = \beta_0 + \beta_1 * Weight + \beta_2*AM + \beta_3*Weight*AM +\epsilon_0$

## 控制变量的影响 VIII
```{r inte7, exercise=TRUE}
suppressMessages(library(stargazer))
mtcars$am <- factor(mtcars$am, labels = c("Auto", "Manual"))
stargazer(lm(mpg ~ wt + am, data = mtcars), type = "text",
          title = "Fuel Efficiency by Weight + Transmission")
```

## 控制变量的影响 IX
```{r inte8, exercise=TRUE}
suppressMessages(library(stargazer))
mtcars$am <- factor(mtcars$am, labels = c("Auto", "Manual"))
stargazer(lm(mpg ~ wt + am + wt*am, data = mtcars), type = "text",
          title = "Fuel Efficiency by Weight*Transimission")
```

## 控制变量的影响 X
$MPG = \beta_0 + \beta_1 * Weight + \beta_2*AM + \epsilon_0$

+ $MPG = \beta_0 + \beta_1 * Weight + \epsilon_0$
+ $MPG = (\beta_0 + \beta_2) + \beta_1 * Weight  + \epsilon_0$

$MPG = \beta_0 + \beta_1 * Weight + \beta_2*AM + \beta_3*Weight*AM +\epsilon_0$

+ $MPG = \beta_0 + \beta_1 * Weight + \epsilon_0$
+ $MPG = (\beta_0 + \beta_2) + (\beta_1+\beta_3） * Weight  + \epsilon_0$

## 整体模型有效性鉴定

所有模型统计鉴定的第一步

+ 模型A$(M_a): y = \beta_0 + \epsilon_0$
+ 模型B$(M_b): y = \beta_0 + \beta_1x_1 + \beta_2x_2 + \epsilon_0$
+ 原假设(Ho): $M_a = M_b$
+ 替代假设($H_a$): $M_a \neq M_b$
+ 等价假设: $\beta_1 = 0$ and $\beta_2 = 0$
+ 统计指标: F-statistic
+ 设定 I 型错误率: $\alpha = 0.05$
+ 计算原假设正确条件下的观测概率: p−value
+ 进行统计推断:简约原则

## 特定参数有效性鉴定

在整体模型通过统计鉴定之后，针对特定变量回归系数的鉴定

+ 模型A$(M_a): y = \beta_0 + \beta_1x_1 + \epsilon_0$
+ 模型B$(M_b): y = \beta_0 + \beta_1x_1 + \beta_2x_2 + \epsilon_0$
+ 原假设(Ho): $\beta_2 = 0$
+ 替代假设($H_a$): $\beta_2 \neq 0$
+ 统计指标: t-statistic
+ 设定 I 型错误率: $\alpha = 0.05$
+ 计算原假设正确条件下的观测概率: p−value

## OLS 模型案例 I
$MPG = \beta_0 + \beta_1*Weight + \beta_2*Clinder + \epsilon_0$
```{r inte9, exercise=TRUE}
suppressMessages(library(stargazer))
stargazer(lm(mpg ~ wt + cyl, data = mtcars), type = "text",
          title = "Fuel Efficiency by Weight and Cylinder")
```

## OLS 模型案例 II
$MPG = \beta_0 + \beta_1 * Weight + \beta_2*AM + \epsilon_0$
```{r inte10, exercise=TRUE}
suppressMessages(library(stargazer))
mtcars$am <- factor(mtcars$am, labels = c("Auto", "Manual"))
stargazer(lm(mpg ~ wt + am, data = mtcars), type = "text",
          title = "Fuel Efficiency by Weight + Transmission")
```

## 一般线性模型到广义线性模型 I
当结果变量不再是连续变量的时候，对应的数据产生过程也发生了变化，没办法再用正态分布来描述其数据分布特征，需要找寻更合适的统计模型。广义线性模型（generalized linear model）是对一般线性模型（linear model）的拓展，有不同的理论视角和框架。最常用的理论框架就是潜在变量模型（latent variable）。
\[y^* = \beta_0 + \beta_1x_1 + \beta_2x_2 + \epsilon_0\]
\begin{equation}
y=
\begin{cases}
0& \text{for $y^* < \tau_0 = 0$}\\
1& \text{for $y^* \ge \tau_0 = 0$}
\end{cases}
\end{equation}

## 一般线性模型到广义线性模型 II
$y^*$的分布特征就决定了最终广义线性模型的形态，针对两分的结果变量，一般有如下两种统计分布可供选择。具体选择哪种统计分布，一般情况下不会影响最终的统计推断:

如果$y^*$ ∼ Normal distribution，最后得到的就是Probit模型

如果$y^*$ ∼ Logistic distribution，最后得到的就是Logit模型

## Logit 模型 I
$Pr(AM) = \rho$

$log(\frac{\rho}{1-\rho}) = \beta_0 + \beta_1*Weight + \beta_2*Clinder + \epsilon_0$

因为$\rho \sim[0,1]$，所以$\frac{\rho}{1-\rho}\sim[0,+\infty]$。经过对数函数变化之后的值域范
围是$[-\infty,+\infty]$。

## Logit 模型 II
```{r inte11, exercise=TRUE}
suppressMessages(library(stargazer))
mtcars$am <- factor(mtcars$am, labels = c("Auto", "Manual"))
stargazer(glm(am ~ wt + cyl, data = mtcars,family = binomial(link = "logit")), type = "text",
          title = "Transmission Type by Weight and Cylinder")
```
